version: "3.9"

services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: ewp
      POSTGRES_PASSWORD: ewp
      POSTGRES_DB: ewp
    ports:
      - "5432:5432"
    volumes:
      - db_data:/var/lib/postgresql/data

  django:
    build:
      context: ./backend/django_service
      dockerfile: Dockerfile
    environment:
      DJANGO_SECRET_KEY: dev-secret-key
      DJANGO_DEBUG: "1"
      DJANGO_DB_ENGINE: django.db.backends.postgresql
      DJANGO_DB_NAME: ewp
      DJANGO_DB_USER: ewp
      DJANGO_DB_PASSWORD: ewp
      DJANGO_DB_HOST: db
      DJANGO_DB_PORT: "5432"
      DJANGO_CORS_ALLOWED_ORIGINS: "http://localhost:5173,http://127.0.0.1:5173"
    depends_on:
      - db
    ports:
      - "8000:8000"
    command: >
      bash -c "python manage.py migrate && python manage.py runserver 0.0.0.0:8000"

  fastapi:
    build:
      context: ./backend/fastapi_service
      dockerfile: Dockerfile
    environment:
      APP_ENV: docker
      DATABASE_URL: postgresql+psycopg2://ewp:ewp@db:5432/ewp
      DJANGO_AUTH_URL: http://django:8000
      DJANGO_SECRET_KEY: dev-secret-key
      CORS_ALLOW_ORIGINS: "http://localhost:5173,http://127.0.0.1:5173"
    depends_on:
      - db
      - django
    ports:
      - "8001:8001"
    command: >
      uvicorn app.main:app --host 0.0.0.0 --port 8001

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    environment:
      VITE_DJANGO_URL: http://127.0.0.1:8000/api
      VITE_FASTAPI_URL: http://127.0.0.1:8001/api/v1
    depends_on:
      - django
      - fastapi
    ports:
      - "5173:5173"

volumes:
  db_data:

